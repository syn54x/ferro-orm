name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  lint-and-format:
    name: Lint & Format (All Pre-commit Hooks)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Run all pre-commit hooks
        run: |
          uv run prek run --all-files

  test-python:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.13', '3.14']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Build Rust extension
        run: |
          uv run maturin develop

      - name: Run pytest
        run: |
          uv run pytest -v --cov=src --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: python-${{ matrix.python-version }}
          name: python-${{ matrix.python-version }}
        continue-on-error: true

  test-rust:
    name: Test Rust
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run Rust tests
        run: |
          cargo test --all-features

  build-check:
    name: Build Check (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@v5

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Build with Maturin
        run: |
          uv run maturin build --release

      - name: Test import
        shell: bash
        run: |
          uv run python -c "import ferro; print('Ferro imported successfully')"

  check-conventional-commits:
    name: Check Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v5

      - name: Install commitizen
        run: |
          uv tool install commitizen

      - name: Check commit messages
        run: |
          # Get all commits in the PR
          git fetch origin main
          COMMITS=$(git log origin/main..HEAD --pretty=format:"%H")

          # Check each commit message
          for commit in $COMMITS; do
            MESSAGE=$(git log -1 --pretty=format:"%s" $commit)

            # Skip merge commits
            if [[ "$MESSAGE" == Merge* ]]; then
              echo "Skipping merge commit: $MESSAGE"
              continue
            fi

            echo "Checking commit: $MESSAGE"
            if ! uv run cz check --commit-msg-file <(git log -1 --pretty=format:"%s%n%n%b" $commit); then
              echo "❌ Commit message does not follow conventional format: $MESSAGE"
              exit 1
            fi
          done

          echo "All commit messages follow conventional format"

  all-checks:
    name: All Checks Passed
    needs: [lint-and-format, test-python, test-rust, build-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint-and-format.result }}" != "success" ]] ||
             [[ "${{ needs.test-python.result }}" != "success" ]] ||
             [[ "${{ needs.test-rust.result }}" != "success" ]] ||
             [[ "${{ needs.build-check.result }}" != "success" ]]; then
            echo "❌ Some checks failed"
            exit 1
          fi
          echo "All checks passed!"
