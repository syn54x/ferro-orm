name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint-and-format:
    name: Lint & Format (Pre-commit / Prek)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1
          cache-on-failure: true

      - name: Cache pre-commit hook environments
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pre-commit
            ~/.cache/prek
          key: precommit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Run all pre-commit hooks
        run: |
          uv run prek run --all-files

  test-rust:
    name: Rust tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1
          cache-on-failure: true

      - name: Run Rust tests
        run: |
          cargo test --all-features

  test-python-pr:
    name: Python tests (PR / 3.13)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1
          cache-on-failure: true

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Build Rust extension
        run: |
          uv run maturin develop

      - name: Run pytest
        run: |
          uv run pytest -v --cov=src --cov-report=xml --cov-report=term

  test-python-main:
    name: Python tests (main / ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.13', '3.14']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1
          cache-on-failure: true

      - name: Install dependencies
        run: |
          uv sync --group dev

      - name: Build Rust extension
        run: |
          uv run maturin develop

      - name: Run pytest
        run: |
          uv run pytest -v --cov=src --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.13'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: python-${{ matrix.python-version }}
          name: python-${{ matrix.python-version }}
        continue-on-error: true

  check-conventional-commits:
    name: Check Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install commitizen
        run: |
          uv tool install commitizen

      - name: Check commit messages
        shell: bash
        run: |
          git fetch origin main
          COMMITS=$(git log origin/main..HEAD --pretty=format:"%H")

          for commit in $COMMITS; do
            MESSAGE=$(git log -1 --pretty=format:"%s" $commit)

            if [[ "$MESSAGE" == Merge* ]]; then
              echo "Skipping merge commit: $MESSAGE"
              continue
            fi

            echo "Checking commit: $MESSAGE"
            if ! uv run cz check --commit-msg-file <(git log -1 --pretty=format:"%s%n%n%b" $commit); then
              echo "âŒ Commit message does not follow conventional format: $MESSAGE"
              exit 1
            fi
          done

          echo "All commit messages follow conventional format"

  all-checks:
    name: All Checks Passed
    needs: [lint-and-format, test-python-pr, test-python-main, test-rust]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs
        shell: bash
        run: |
          ok() { [[ "$1" == "success" || "$1" == "skipped" ]]; }

          if ! ok "${{ needs.lint-and-format.result }}"; then exit 1; fi
          if ! ok "${{ needs.test-python-pr.result }}"; then exit 1; fi
          if ! ok "${{ needs.test-python-main.result }}"; then exit 1; fi
          if ! ok "${{ needs.test-rust.result }}"; then exit 1; fi

          echo "All checks passed!"
